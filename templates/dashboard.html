{% extends "base.html" %}

{% block title %}Dashboard - Technovaganza CTF{% endblock %}

{% block content %}
<div class="row">
    <!-- Leaderboard Section -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Live Leaderboard</h5>
                <small class="opacity-75">Real-time updates without page reload</small>
            </div>
            <div class="card-body">
                <div id="leaderboard-container">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Team</th>
                                <th>Score</th>
                            </tr>
                        </thead>
                        <tbody id="leaderboard-body">
                            {% for entry in leaderboard %}
                            <tr {% if entry.teamname == current_user.teamname %}class="table-primary"{% endif %}>
                                <td>{{ loop.index }}</td>
                                <td>
                                    {{ entry.teamname }}
                                    {% if entry.teamname == current_user.teamname %}
                                    <span class="badge bg-primary">You</span>
                                    {% endif %}
                                </td>
                                <td>{{ entry.score }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Points System Info -->
        <div class="card mt-3">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">üèÜ Points System</h6>
            </div>
            <div class="card-body">
                <small>
                    <strong>Solving Order Rewards:</strong><br>
                    ‚Ä¢ 1st Solver: 100 points<br>
                    ‚Ä¢ 2nd Solver: 90 points<br>
                    ‚Ä¢ 3rd Solver: 80 points<br>
                    ‚Ä¢ 4th+ Solver: 50 points<br>
                    <em>Solve early for more points!</em>
                </small>
            </div>
        </div>

        <!-- Connection Status -->
        <div class="card mt-3">
            <div class="card-header bg-dark text-white">
                <h6 class="mb-0">üîó Connection Status</h6>
            </div>
            <div class="card-body">
                <small>
                    <span id="connection-status" class="text-success">‚óè Connected (Live Updates)</span>
                    <br>
                    <em>Leaderboard updates automatically</em>
                </small>
            </div>
        </div>
    </div>

    <!-- Challenges Section -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">Challenges</h5>
                <small>
                    <span class="badge bg-success">Available</span>
                    <span class="badge bg-primary">Solved by You</span>
                    <span class="badge bg-warning">Many Attempts</span>
                </small>
            </div>
            <div class="card-body">
                <div class="row" id="challenges-container">
                    {% for challenge in challenges %}
                    <div class="col-md-6 mb-3">
                        <div class="card challenge-card 
                            {% if challenge.id in solved_challenge_ids %}border-primary bg-light
                            {% else %}border-success
                            {% endif %}">
                            <div class="card-body">
                                <h6 class="card-title">{{ challenge.name }}</h6>
                                <p class="card-text">
                                    <small class="text-muted">Category: {{ challenge.category }}</small><br>
                                    <small class="text-muted">
                                        Solved by: <span id="solved-count-{{ challenge.id }}">{{ challenge_solve_info[challenge.id].solved_count }}</span> teams
                                    </small>
                                </p>
                                
                                {% if challenge.id in solved_challenge_ids %}
                                    {% set user_submission = namespace(points=0) %}
                                    {% for submission in current_user.submissions %}
                                        {% if submission.challenge_id == challenge.id and submission.is_correct %}
                                            {% set user_submission.points = submission.points_earned %}
                                        {% endif %}
                                    {% endfor %}
                                    
                                    <div class="alert alert-success py-1 mb-2">
                                        <small>‚úÖ Solved - {{ user_submission.points }} points earned</small>
                                    </div>
                                    <a href="{{ url_for('view_challenge', challenge_id=challenge.id) }}" 
                                       class="btn btn-outline-primary btn-sm">
                                        View Solution
                                    </a>
                                {% else %}
                                    {% set user_attempt = namespace(count=0) %}
                                    {% for submission in current_user.submissions %}
                                        {% if submission.challenge_id == challenge.id %}
                                            {% set user_attempt.count = submission.attempt_count %}
                                        {% endif %}
                                    {% endfor %}
                                    
                                    {% if user_attempt.count >= 15 %}
                                        <div class="alert alert-danger py-1 mb-2">
                                            <small>‚ö†Ô∏è {{ 20 - user_attempt.count }} attempts left</small>
                                        </div>
                                    {% elif user_attempt.count >= 10 %}
                                        <div class="alert alert-warning py-1 mb-2">
                                            <small>‚ö†Ô∏è {{ 20 - user_attempt.count }} attempts left</small>
                                        </div>
                                    {% endif %}
                                    
                                    <div class="alert alert-info py-1 mb-2">
                                        <small>üéØ Click below to solve this challenge</small>
                                    </div>
                                    
                                    <a href="{{ url_for('view_challenge', challenge_id=challenge.id) }}" 
                                       class="btn btn-outline-success btn-sm">
                                        Solve Challenge
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    var socket = io();
    
    // Connection status
    socket.on('connect', function() {
        document.getElementById('connection-status').innerHTML = '‚óè Connected (Live Updates)';
        document.getElementById('connection-status').className = 'text-success';
    });
    
    socket.on('disconnect', function() {
        document.getElementById('connection-status').innerHTML = '‚óè Disconnected';
        document.getElementById('connection-status').className = 'text-danger';
    });

    // Handle leaderboard updates
    socket.on('leaderboard_update', function(data) {
        console.log('Leaderboard update received');
        
        // Fetch updated leaderboard data via AJAX
        fetch('/api/leaderboard')
            .then(response => response.json())
            .then(leaderboardData => {
                updateLeaderboard(leaderboardData);
            })
            .catch(error => {
                console.error('Error fetching leaderboard:', error);
            });
    });

    // Handle challenge solved events
    socket.on('challenge_solved', function(data) {
        console.log('Challenge solved:', data);
        
        // Show notification
        showNotification(`üéâ Challenge "${data.challenge_name}" solved by ${data.solver_team}!`, 'success');
        
        // Update solved count for that challenge
        const solvedCountElement = document.getElementById(`solved-count-${data.challenge_id}`);
        if (solvedCountElement) {
            const currentCount = parseInt(solvedCountElement.textContent);
            solvedCountElement.textContent = currentCount + 1;
        }
    });

    function updateLeaderboard(leaderboardData) {
        const tbody = document.getElementById('leaderboard-body');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        leaderboardData.forEach((entry, index) => {
            const row = document.createElement('tr');
            const isCurrentUser = entry.teamname === "{{ current_user.teamname }}";
            
            if (isCurrentUser) {
                row.className = 'table-primary';
            }
            
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>
                    ${entry.teamname}
                    ${isCurrentUser ? '<span class="badge bg-primary">You</span>' : ''}
                </td>
                <td>${entry.score}</td>
            `;
            
            tbody.appendChild(row);
        });
    }

    function showNotification(message, type) {
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show`;
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Add to page
        const container = document.querySelector('.container');
        container.insertBefore(notification, container.firstChild);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.remove();
            }
        }, 5000);
    }

    // Request initial leaderboard data
    socket.emit('request_leaderboard');
</script>

<style>
    .challenge-card {
        transition: transform 0.2s ease-in-out;
    }
    .challenge-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}